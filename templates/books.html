<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kitaplar - Kütüphane</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .navbar {
            background: rgba(255, 255, 255, 0.95) !important;
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            transition: transform 0.3s;
        }
        .card:hover {
            transform: translateY(-5px);
        }
    </style>
</head>
<body>
    {% include 'navbar.html' %}
    
    <div class="container mt-5">
        <div class="row mb-4">
            <div class="col-12">
                <h1 class="text-white fw-bold">
                    <i class="fas fa-books"></i> Kitaplar
                </h1>
            </div>
        </div>
        
        <div id="booksContainer" class="row">
            <div class="col-12 text-center">
                <div class="spinner-border text-white" role="status">
                    <span class="visually-hidden">Yükleniyor...</span>
                </div>
                <p class="text-white mt-3">Kitaplar yükleniyor...</p>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const token = localStorage.getItem('token');
        if (!token) {
            window.location.href = '/login';
        }
        
        async function loadBooks() {
            try {
                const response = await fetch('/api/books/', {
                    headers: { 
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('API Response:', data);
                
                // Backend'den gelen veriyi parse et
                let books = [];
                if (data.success && data.books) {
                    books = data.books;
                } else if (Array.isArray(data)) {
                    books = data;
                } else if (data.books) {
                    books = data.books;
                } else if (data.data) {
                    books = data.data;
                }
                
                console.log('Parsed books:', books);
                
                // Backend field isimleriyle normalize et
                const normalizedBooks = books.map(book => ({
                    id: book.kitapid || book.id,
                    title: book.baslik || book.title || 'Başlık Yok',
                    author: (book.yazar_ad && book.yazar_soyad) 
                        ? `${book.yazar_ad} ${book.yazar_soyad}` 
                        : (book.author || 'Belirtilmemiş'),
                    isbn: book.isbn || '-',
                    category: book.katagori_adi || book.category || 'Belirtilmemiş',
                    available: (book.musait_adet > 0) || book.available || false,
                    yayin_yili: book.yayin_yili
                }));
                
                console.log('Normalized books:', normalizedBooks);
                
                if (normalizedBooks.length === 0) {
                    throw new Error('Veritabanında kitap bulunamadı');
                }
                
                displayBooks(normalizedBooks);
                
            } catch (error) {
                console.error('API hatası, test verisi gösteriliyor:', error);
                
                // TEST VERİSİ
                const testBooks = [
                    {
                        id: 1,
                        title: '1984',
                        author: 'George Orwell',
                        isbn: '978-0451524935',
                        category: 'Distopya',
                        available: true,
                        yayin_yili: 1949
                    },
                    {
                        id: 2,
                        title: 'Suç ve Ceza',
                        author: 'Fyodor Dostoyevski',
                        isbn: '978-0143058144',
                        category: 'Klasik',
                        available: true,
                        yayin_yili: 1866
                    },
                    {
                        id: 3,
                        title: 'Şeker Portakalı',
                        author: 'Jose Mauro de Vasconcelos',
                        isbn: '978-9750719387',
                        category: 'Roman',
                        available: false,
                        yayin_yili: 1968
                    },
                    {
                        id: 4,
                        title: 'Satranç',
                        author: 'Stefan Zweig',
                        isbn: '978-9750718544',
                        category: 'Hikaye',
                        available: true,
                        yayin_yili: 1941
                    },
                    {
                        id: 5,
                        title: 'Simyacı',
                        author: 'Paulo Coelho',
                        isbn: '978-0062315007',
                        category: 'Felsefe',
                        available: true,
                        yayin_yili: 1988
                    },
                    {
                        id: 6,
                        title: 'Küçük Prens',
                        author: 'Antoine de Saint-Exupéry',
                        isbn: '978-0156012195',
                        category: 'Masal',
                        available: true,
                        yayin_yili: 1943
                    },
                    {
                        id: 7,
                        title: 'Hayvan Çiftliği',
                        author: 'George Orwell',
                        isbn: '978-0451526342',
                        category: 'Alegori',
                        available: true,
                        yayin_yili: 1945
                    }
                ];
                
                displayBooks(testBooks);
                
                const container = document.getElementById('booksContainer');
                container.insertAdjacentHTML('afterbegin', `
                    <div class="col-12 mb-3">
                        <div class="alert alert-warning alert-dismissible fade show">
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                            <h5><i class="fas fa-exclamation-triangle"></i> Uyarı: Test Modu</h5>
                            <p class="mb-2"><strong>Backend veritabanı boş veya bağlantı yok, test verisi gösteriliyor.</strong></p>
                            <hr>
                            <small><strong>Hata:</strong> ${error.message}</small><br>
                            <small><strong>Çözüm:</strong> Veritabanına kitap ekleyin veya backend'i kontrol edin.</small>
                        </div>
                    </div>
                `);
            }
        }
        
        function displayBooks(books) {
            const container = document.getElementById('booksContainer');
            
            if (!books || books.length === 0) {
                container.innerHTML = `
                    <div class="col-12">
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i> Henüz kitap bulunmuyor.
                        </div>
                    </div>
                `;
                return;
            }
            
            const booksHTML = books.map(book => `
                <div class="col-md-4 mb-4">
                    <div class="card h-100">
                        <div class="card-body">
                            <div class="d-flex justify-content-between mb-3">
                                <h5 class="card-title fw-bold">${book.title}</h5>
                                <span class="badge ${book.available ? 'bg-success' : 'bg-danger'}">
                                    ${book.available ? ' Mevcut' : ' Ödünçte'}
                                </span>
                            </div>
                            <p class="text-muted mb-2">
                                <i class="fas fa-user"></i> <strong>Yazar:</strong> ${book.author}
                            </p>
                            ${book.isbn !== '-' ? `
                            <p class="text-muted mb-2">
                                <i class="fas fa-barcode"></i> <strong>ISBN:</strong> ${book.isbn}
                            </p>
                            ` : ''}
                            <p class="text-muted mb-2">
                                <i class="fas fa-tag"></i> <strong>Kategori:</strong> ${book.category}
                            </p>
                            ${book.yayin_yili ? `
                            <p class="text-muted mb-3">
                                <i class="fas fa-calendar"></i> <strong>Yayın:</strong> ${book.yayin_yili}
                            </p>
                            ` : '<div class="mb-3"></div>'}
                            ${book.available ? `
                                <button class="btn btn-primary w-100" onclick="borrowBook(${book.id})">
                                    <i class="fas fa-hand-holding-heart"></i> Ödünç Al
                                </button>
                            ` : `
                                <button class="btn btn-secondary w-100" disabled>
                                    <i class="fas fa-clock"></i> Müsait Değil
                                </button>
                            `}
                        </div>
                    </div>
                </div>
            `).join('');
            
            const alertDiv = container.querySelector('.alert');
            container.innerHTML = booksHTML;
            if (alertDiv) {
                container.insertAdjacentElement('afterbegin', alertDiv);
            }
        }
        
        async function borrowBook(bookId) {
            if (!confirm('Bu kitabı ödünç almak istediğinize emin misiniz?')) return;
            
            try {
                const response = await fetch(`/api/loans/borrow/${bookId}`, {
                    method: 'POST',
                    headers: { 
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    alert(' Kitap başarıyla ödünç alındı!');
                    loadBooks();
                } else {
                    alert(' ' + (data.message || 'Hata oluştu'));
                }
            } catch (error) {
                alert(' Hata: ' + error.message);
            }
        }
        
        function logout() {
            localStorage.clear();
            window.location.href = '/login';
        }
        
        loadBooks();
    </script>
</body>
</html>